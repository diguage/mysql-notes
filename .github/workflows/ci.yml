
name: GitHub Pages
on:
  push:
    branches:
      - master
jobs:
  deploy:
    # https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idruns-on
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/checkout
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0

      # https://github.com/actions/setup-node
      - name: Setup Node.js ğŸ•¸
        uses: actions/setup-node@v3
        with:
          # https://github.com/nvm-sh/nvm#long-term-support
          node-version: 'lts/*'

      # https://github.com/ruby/setup-ruby
      - name: Setup Ruby ğŸ’
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1

      - name: Install AsciiDoctor ğŸ¶
        run: |
          gem install asciidoctor
          gem install asciidoctor-diagram
          gem install asciidoctor-comment-links
          gem install rouge

      - name: Install Graphviz ğŸ°
        run: |
          sudo apt update -y -m
          sudo apt install -y python3-pip
          # https://graphviz.org/
          sudo apt install -y graphviz
          # http://blockdiag.com/en/seqdiag/index.html
          pip3 install seqdiag
          # http://blockdiag.com/en/blockdiag/index.html
          pip3 install blockdiag
          # http://blockdiag.com/en/actdiag/index.html
          pip3 install actdiag
          # http://blockdiag.com/en/nwdiag/index.html
          pip3 install nwdiag
          # https://github.com/Deep-Symmetry/bytefield-svg
          npm install -g bytefield-svg
          # https://github.com/gtudan/bpmn-js-cmd
          npm install -g bpmn-js-cmd
          sudo apt -y install plantuml

      - name: Run Hugo ğŸ—
        run: |
          asciidoctor -a toc=left -a stylesdir=assets/styles/ -a linkcss -r asciidoctor-multipage -r asciidoctor-comment-links -b multipage_html5 -D . index.adoc

      - name: Add Reward Qrcode ğŸ’°
        run: |
          find . -name "*.html" | grep -v "preface.html" | xargs -I {} sed -i "s|<div id=\"content\">|<div id=\"content\"><div class=\"sect2\"><h3 id=\"_å‹æƒ…æ”¯æŒ\">å‹æƒ…æ”¯æŒ</h3><div class=\"paragraph\"><p>å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªç¬”è®°å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼Œçœ‹åœ¨Dç“œå“¥ç è¿™ä¹ˆå¤šå­—çš„è¾›è‹¦ä¸Šï¼Œè¯·å‹æƒ…æ”¯æŒä¸€ä¸‹ï¼ŒDç“œå“¥æ„Ÿæ¿€ä¸å°½ï¼ŒğŸ˜œ</p></div><table class=\"tableblock frame-none grid-all stretch\"><colgroup><col style=\"width: 50%;\"><col style=\"width: 50%;\"></colgroup><tbody><tr><td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><span class=\"image\"><img src=\"assets/images/alipay.png\" alt=\"æ”¯ä»˜å®\" width=\"85%\" title=\"æ”¯ä»˜å®\"></span></p></td><td class=\"tableblock halign-center valign-top\"><p class=\"tableblock\"><span class=\"image\"><img src=\"assets/images/wxpay.jpg\" alt=\"å¾®ä¿¡\" width=\"85%\" title=\"å¾®ä¿¡\"></span></p></td></tr></tbody></table><div class=\"paragraph\"><p>æœ‰äº›æ‰“èµçš„æœ‹å‹å¸Œæœ›å¯ä»¥åŠ ä¸ªå¥½å‹ï¼Œæ¬¢è¿å…³æ³¨D ç“œå“¥çš„å¾®ä¿¡å…¬ä¼—å·ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡å…¬ä¼—å·çš„å›å¤ç›´æ¥ç»™æˆ‘å‘ä¿¡æ¯ã€‚</p></div><div class=\"paragraph\"><p><span class=\"image\"><img src=\"assets/images/wx-jikerizhi.png\" alt=\"wx jikerizhi\" width=\"98%\"></span></p></div><div class=\"admonitionblock tip\"><table><tbody><tr><td class=\"icon\"><i class=\"fa icon-tip\" title=\"Tip\"></i></td><td class=\"content\"><strong>å…¬ä¼—å·çš„å¾®ä¿¡å·æ˜¯: <code>jikerizhi</code></strong>ã€‚<em>å› ä¸ºä¼—æ‰€å‘¨çŸ¥çš„åŸå› ï¼Œæœ‰æ—¶å›¾ç‰‡åŠ è½½ä¸å‡ºæ¥ã€‚ å¦‚æœå›¾ç‰‡åŠ è½½ä¸å‡ºæ¥å¯ä»¥ç›´æ¥é€šè¿‡æœç´¢å¾®ä¿¡å·æ¥æŸ¥æ‰¾æˆ‘çš„å…¬ä¼—å·ã€‚</em></td></tr></tbody></table></div></div>|" {}
          find . -name "*.html" | grep -v "index.html" | xargs -I {} sed -i 's|</head>|<script>var _hmt = _hmt \|\| [];(function () {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?ae79ae5854e141fa6c9a217b5dcf0e45";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();</script></head>|' {}

      - name: Compress Style ğŸ­
        run: |
          npm install cssnano-cli --location=global
          cd assets/styles/
          echo -e '\na{text-decoration:none;}p>code,strong>code{color: #d14 !important;background-color: #f5f5f5 !important;}' >> asciidoctor.css  
          for f in `ls *.css`;
          do
            fn="${f%.*}.min.css";
            cssnano $f $fn;
            rm -rf $f;
            mv $fn $f
          done

      - name: Rsync Deploy ğŸ¹
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avzr --delete --exclude=".*" ./assets ./*.html
          path: .
          remote_path: ${{ secrets.DEPLOY_PATH }}
          remote_host: ${{ secrets.DEPLOY_HOST }}
          remote_port: ${{ secrets.DEPLOY_PORT }}
          remote_user: ${{ secrets.DEPLOY_USER }}
          remote_key: ${{ secrets.DEPLOY_KEY }}

      - name: Change Files Mod ğŸ”
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          port: ${{ secrets.DEPLOY_PORT }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            sudo chmod -R 777 *
